global
    log stdout format raw local0
    maxconn 5000

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s

# Use platform DNS (so *.railway.internal resolves)
resolvers dns
    parse-resolv-conf
    resolve_retries 3
    timeout retry   1s
    hold valid     10s

frontend fe_main
    # Listens on $PORT (Railway-provided, default 8080 from Dockerfile)
    bind ":$PORT"
    mode http
    default_backend be_vad

backend be_vad
    mode http
    balance roundrobin

    # HTTP health check on /health
    option httpchk GET /health
    http-check expect status 200

    # Health-check tuning + prefer IPv6
    default-server inter 3s rise 2 fall 3 check resolvers dns resolve-prefer ipv6

    # DNS-based discovery of all IPs for the service
    # Env vars expanded here: e.g. vad-service-2.railway.internal:8000
    server-template vad 1-10 "$VAD_SERVICE_HOST":"$VAD_SERVICE_PORT"